# Using Golang

## Prerequisite

- install Go1.5
- install PostgreSQL

## Making Golang Shared Object

We can make shared object in golang with Go 1.5 compiler.
This example is how to use a shared object generated by Go 1.5 from PostgreSQL and the example code provides functionality to get currency exchange rates from Yen to Dollar.

Steps are below.
 - Note: These steps assume that you are using Ubuntu 14.05 (64bit) and you are 'postgres' user.

1. make Go code
``` Go
package main

import (
	"strconv"
	"strings"
	"github.com/PuerkitoBio/goquery"
	"log"
)

//export jpy
func jpy() float32 {
	var cur float32 = 0.0

	url := "https://www.google.com/finance/converter?a=1&from=USD&to=JPY"
	doc, err := goquery.NewDocument(url)

	if err != nil {
		log.Println(err)
		return cur
	}

	doc.Find("div#currency_converter_result").Each(func(_ int, s *goquery.Selection) {
		line := s.Text()
		l := strings.Split(line, " ")
		v, _ := strconv.ParseFloat(l[3], 32)
		cur = float32(v)
		log.Println(v)
	})

	return float32(cur)
}

func init() {
	log.Println("loaded.")
}

func main() {
	c := jpy()
	log.Println(c)
}
```

This code uses [Google Currency Converter](https://www.google.com/finance/converter) and [goquery](https://github.com/PuerkitoBio/goquery) for parsing the result.
The main() function above is for debugging only.

1. compile

We can compile source code with '-buildmode=c-shared' option to make shared object.
It assumes you are at the same directory with the source code and configure GOPATH environment variable.
```
$ go get github.com/PuerkitoBio/goquery
$ go build -buildmode=c-shared -o libgo.so libgo.go
$ ls libgo.*
libgo.go  libgo.h  libgo.so
```

1. make wrapper function

We call the function in libgo.so through PostgreSQL wrapper function.
- wrapper

``` C
#include "postgres.h"
#include <string.h>
#include "fmgr.h"
#include "utils/geo_decls.h"
#include "libgo.h"

#ifdef PG_MODULE_MAGIC
PG_MODULE_MAGIC;
#endif

/* by value */
PG_FUNCTION_INFO_V1(get_jpy);

Datum
get_jpy(PG_FUNCTION_ARGS)
{
        int32   arg = PG_GETARG_INT32(0);
        float4  result = arg * jpy();
        PG_RETURN_FLOAT4(result);
}
```
This wrapper function is get_jpy() and it calls jpy() implemented in Golang.

- Makefile
```
# contrib/libgo/Makefile

INCLUDEDIRS := -I.
INCLUDEDIRS += -I$(shell pg_config --includedir-server)
INCLUDEDIRS += -I$(shell pg_config --includedir)

LIBDIR := -L.
LIBDIR += -L$(shell pg_config --libdir)
LIBINSTALL = $(shell pg_config --pkglibdir)


callgo.so: callgo.c Makefile
                        gcc -fpic -o callgo.o -c callgo.c $(INCLUDEDIRS)
                        gcc -shared -o callgo.so callgo.o $(LIBDIR) -lpq -lm -lgo

install:
                        cp callgo.so $(LIBINSTALL)
                        cp libgo.so $(LIBINSTALL)
                        
```

Let's compile and install.
```
$ make
gcc -fpic -o callgo.o -c callgo.c -I. -I/usr/local/postgres/include/server -I/usr/local/postgres/include
gcc -shared -o callgo.so callgo.o -L. -L/usr/local/postgres/lib -lpq -lm -lgo
$ make install
cp callgo.so /usr/local/postgres/lib
cp libgo.so /usr/local/postgres/lib
```

1. register function

We can register function to call get_jpy by following SQL.
``` bash
$ pg_ctl -D /usr/local/postgres/data -l logfile start
server starting
$ createdb libgotest
$ psql libgotest
psql (9.6devel)
Type "help" for help.

libgotest=# CREATE FUNCTION get_jpy(integer) RETURNS float4 AS 'callgo.so', 'get_jpy' LANGUAGE C STRICT;
CREATE FUNCTION
libgotest=# select get_jpy(10);
 get_jpy
---------
 1210.32
(1 row)

libgotest=#

```

# Conclusion

- It's easy to use Golang from PostgreSQL.
- We can create various kind of function easily in Golang.
  - We may be able to use goroutine (lighweight thread) to handle heavy task.
